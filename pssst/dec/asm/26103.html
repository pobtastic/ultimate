<!DOCTYPE html>
<html>
<head>
<title>PSSST: Routine at 26103</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../skoolkit-dark.css" />
<link rel="stylesheet" type="text/css" href="../skoolkit-wide.css" />
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-75RERFCHBG"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-75RERFCHBG');
</script>
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="ultimate" src="../images/ultimate.png" /> <img alt="logo" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="25850.html">25850</a>
</td>
<td class="up">Up: <a href="../maps/all.html#26103">Map</a></td>
<td class="next">
Next: <a href="26242.html">26242</a>
</td>
</tr>
</table>
<div class="description">26103: Animate Explosion</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
</div>
<table class="input">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">IX</td>
<td class="register-desc">Explosion animation object</td>
</tr>
</table>
</td>
</tr>
<tr>
<td class="asm-label">AnimateExplosion</td>
<td class="address-2"><span id="26103"></span>26103</td>
<td class="instruction">LD HL,24086</td>
<td class="comment-1" rowspan="1"><span class="register">HL</span>=<a href="24086.html">CurrentBug_ID</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="26106"></span>26106</td>
<td class="instruction">INC (HL)</td>
<td class="comment-1" rowspan="1">Increment <a href="24086.html">CurrentBug_ID</a> by one.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="26107"></span>26107</td>
<td class="instruction">LD C,(IX+4)</td>
<td class="comment-1" rowspan="1"><span class="register">C</span>=explosion animation frame.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="26110"></span>26110</td>
<td class="instruction">LD B,(IX+5)</td>
<td class="comment-1" rowspan="1"><span class="register">B</span>=explosion animation state.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="26113"></span>26113</td>
<td class="instruction">LD A,(24087)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=<a href="24087.html">GameTimer</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="26116"></span>26116</td>
<td class="instruction">AND B</td>
<td class="comment-1" rowspan="3">Increment frame if timer &amp; state are both zero.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="26117"></span>26117</td>
<td class="instruction">JR NZ,<a href="26103.html#26122">ExplosionFetchSpriteFrame</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="26119"></span>26119</td>
<td class="instruction">INC (IX+4)</td>
</tr>
<tr>
<td class="asm-label">ExplosionFetchSpriteFrame</td>
<td class="address-2"><span id="26122"></span>26122</td>
<td class="instruction">LD A,C</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=current explosion animation frame.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="26123"></span>26123</td>
<td class="instruction">SLA C</td>
<td class="comment-1" rowspan="2">Create an offset using the animation frame ID.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="26125"></span>26125</td>
<td class="instruction">LD B,0</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="26127"></span>26127</td>
<td class="instruction">LD HL,26242</td>
<td class="comment-1" rowspan="1"><span class="register">HL</span>=<a href="26242.html">ExplosionLookupTable</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="26130"></span>26130</td>
<td class="instruction">ADD HL,BC</td>
<td class="comment-1" rowspan="1"><span class="register">HL</span>=<span class="register">HL</span> + offset.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="26131"></span>26131</td>
<td class="instruction">LD E,(HL)</td>
<td class="comment-1" rowspan="3"><span class="register">DE</span>=fetch sprite frame address from <span class="register">HL</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="26132"></span>26132</td>
<td class="instruction">INC HL</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="26133"></span>26133</td>
<td class="instruction">LD D,(HL)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="26134"></span>26134</td>
<td class="instruction">LD L,(IX+1)</td>
<td class="comment-1" rowspan="1"><span class="register">HL</span>=X/Y co-ordinates of the exploding actor.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="26137"></span>26137</td>
<td class="instruction">LD H,(IX+2)</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="26140"></span>26140</td>
<td class="instruction">CP 6</td>
<td class="comment-1" rowspan="2">If the current frame &gt;= 6 then the animation has finished.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="26142"></span>26142</td>
<td class="instruction">JR NC,<a href="26103.html#26164">AnimateExplosion_End</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="26144"></span>26144</td>
<td class="instruction">CP 3</td>
<td class="comment-1" rowspan="2">If the current frame &gt;= 3 then we're halfway done.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="26146"></span>26146</td>
<td class="instruction">JR NC,<a href="26103.html#26236">AnimateExplosion_2</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="26148"></span>26148</td>
<td class="instruction">CALL <a href="29980.html">29980</a></td>
<td class="comment-1" rowspan="1">Call <a href="29980.html">29980</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="26151"></span>26151</td>
<td class="instruction">LD A,(24089)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=<a href="24089.html">RandomNumber</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="26154"></span>26154</td>
<td class="instruction">AND %00000111</td>
<td class="comment-1" rowspan="1">Keep only bits 0-2.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="26156"></span>26156</td>
<td class="instruction">OR %01000010</td>
<td class="comment-1" rowspan="1">Set bits 1 and 6 (BRIGHT).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="26158"></span>26158</td>
<td class="instruction">LD (IX+3),A</td>
<td class="comment-1" rowspan="1">Update with a random colour</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="26161"></span>26161</td>
<td class="instruction">JP <a href="29776.html">ColouriseSprite</a></td>
<td class="comment-1" rowspan="1">Jump to <a href="29776.html">ColouriseSprite</a>.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="26164"></span>
<div class="comments">
<div class="paragraph">
After an explosion, we check if it was the player that died!
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">AnimateExplosion_End</td>
<td class="address-2"><span id="26164"></span>26164</td>
<td class="instruction">LD A,(IX+6)</td>
<td class="comment-1" rowspan="2">Update anim object so "animating" = "direction".</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="26167"></span>26167</td>
<td class="instruction">LD (IX+0),A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="26170"></span>26170</td>
<td class="instruction">CALL <a href="30137.html">StoreEntity</a></td>
<td class="comment-1" rowspan="1">Call <a href="30137.html">StoreEntity</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="26173"></span>26173</td>
<td class="instruction">CALL <a href="29980.html#29990">29990</a></td>
<td class="comment-1" rowspan="1">Call <a href="29980.html#29990">29990</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="26176"></span>26176</td>
<td class="instruction">LD (IX+0),0</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="26180"></span>26180</td>
<td class="instruction">LD A,(IX+6)</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="26183"></span>26183</td>
<td class="instruction">AND %00111111</td>
<td class="comment-1" rowspan="1">Keep only bits 0-5.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="26185"></span>26185</td>
<td class="instruction">CP 3</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="26187"></span>26187</td>
<td class="instruction">RET NC</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="26188"></span>26188</td>
<td class="instruction">CP 2</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="26190"></span>26190</td>
<td class="instruction">JP NZ,<a href="24720.html#24746">PlayerTurnEnds</a></td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="26193"></span>26193</td>
<td class="instruction">LD HL,24099</td>
<td class="comment-1" rowspan="1"><span class="register">HL</span>=<a href="24099.html">24099</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="26196"></span>26196</td>
<td class="instruction">LD BC,24109</td>
<td class="comment-1" rowspan="1"><span class="register">BC</span>=<a href="24099.html#24109">24109</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="26199"></span>26199</td>
<td class="instruction">LD A,(24089)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=<a href="24089.html">RandomNumber</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="26202"></span>26202</td>
<td class="instruction">AND %00000111</td>
<td class="comment-1" rowspan="1">Keep only bits 0-2.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="26204"></span>26204</td>
<td class="instruction">LD E,A</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="26205"></span>26205</td>
<td class="instruction">LD D,0</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="26207"></span>26207</td>
<td class="instruction">ADD HL,DE</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label">AnimateExplosion_0</td>
<td class="address-2"><span id="26208"></span>26208</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="26209"></span>26209</td>
<td class="instruction">AND A</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="26210"></span>26210</td>
<td class="instruction">JR Z,<a href="26103.html#26225">AnimateExplosion_1</a></td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="26212"></span>26212</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="26213"></span>26213</td>
<td class="instruction">PUSH HL</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="26214"></span>26214</td>
<td class="instruction">AND A</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="26215"></span>26215</td>
<td class="instruction">SBC HL,BC</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="26217"></span>26217</td>
<td class="instruction">POP HL</td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="26218"></span>26218</td>
<td class="instruction">JR NZ,<a href="26103.html#26208">AnimateExplosion_0</a></td>
<td class="comment-1" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="26220"></span>26220</td>
<td class="instruction">LD HL,24099</td>
<td class="comment-1" rowspan="1"><span class="register">HL</span>=<a href="24099.html">24099</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="26223"></span>26223</td>
<td class="instruction">JR <a href="26103.html#26208">AnimateExplosion_0</a></td>
<td class="comment-1" rowspan="1">Jump to <a href="26103.html#26208">AnimateExplosion_0</a>.</td>
</tr>
<tr>
<td class="asm-label">AnimateExplosion_1</td>
<td class="address-2"><span id="26225"></span>26225</td>
<td class="instruction">LD A,(24183)</td>
<td class="comment-1" rowspan="1"><span class="register">A</span>=<a href="24183.html">24183</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="26228"></span>26228</td>
<td class="instruction">AND %00000111</td>
<td class="comment-1" rowspan="1">Keep only bits 0-2.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="26230"></span>26230</td>
<td class="instruction">OR %00001000</td>
<td class="comment-1" rowspan="1">Set bit 3.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="26232"></span>26232</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-1" rowspan="1">Stash the result at the address held by <span class="register">HL</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="26233"></span>26233</td>
<td class="instruction">JP <a href="24720.html#24746">PlayerTurnEnds</a></td>
<td class="comment-1" rowspan="1">Jump to <a href="24720.html#24746">PlayerTurnEnds</a>.</td>
</tr>
<tr>
<td class="asm-label">AnimateExplosion_2</td>
<td class="address-2"><span id="26236"></span>26236</td>
<td class="instruction">CALL <a href="29861.html#29867">29867</a></td>
<td class="comment-1" rowspan="1">Call <a href="29861.html#29867">29867</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="26239"></span>26239</td>
<td class="instruction">JP <a href="29980.html#29993">29993</a></td>
<td class="comment-1" rowspan="1">Jump to <a href="29980.html#29993">29993</a>.</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="25850.html">25850</a>
</td>
<td class="up">Up: <a href="../maps/all.html#26103">Map</a></td>
<td class="next">
Next: <a href="26242.html">26242</a>
</td>
</tr>
</table>
<footer>
<div class="release"></div>
<div class="copyright">&copy; 1983 Ultimate Play the Game &copy; 2023 ArcadeGeek LTD.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.10.</div>
<div><a href="../../asm/65F7.html">Switch to hexadecimal</a>.</div>
</footer>
</body>
</html>